\documentclass[12pt,a4paper,landscape]{amsart}
\usepackage{amsfonts}
\usepackage{amsthm}
\usepackage{amsmath}
\usepackage{amscd}
\usepackage[latin2]{inputenc}
\usepackage{t1enc} \usepackage[mathscr]{eucal}
\usepackage{indentfirst}
\usepackage{graphicx}
\usepackage{graphics}
\usepackage{pict2e}
\usepackage{epic}
\numberwithin{equation}{section}
\usepackage[margin=2.9cm]{geometry}
\usepackage{epstopdf} 

 \def\numset#1{{\\mathbb #1}}

 

\theoremstyle{plain}
\newtheorem{Th}{Theorem}[section]
\newtheorem{Lemma}[Th]{Lemma}
\newtheorem{Cor}[Th]{Corollary}
\newtheorem{Prop}[Th]{Proposition}

 \theoremstyle{definition}
\newtheorem{Def}[Th]{Definition}
\newtheorem{Conj}[Th]{Conjecture}
\newtheorem{Rem}[Th]{Remark}
\newtheorem{?}[Th]{Problem}
\newtheorem{Ex}[Th]{Example}

\newcommand{\im}{\operatorname{im}}
\newcommand{\Hom}{{\rm{Hom}}}
\newcommand{\diam}{{\rm{diam}}}
\newcommand{\ovl}{\overline}
%\newcommand{\M}{\mathbb{M}}

\begin{document}

\title{Torus-Ray Intersections for 3D Graphics // Path to Enlightenment}

\author[Lars]

\section{Deriving the Roots}
We start out with the implicit surface equation of a torus with radius $r$ and width $w$. Here $\hat{x}, \hat{y}, \hat{z}$ correspond to some point $X$:
\begin{align*}
  \left( r - \sqrt{\hat{x}^2 + \hat{y}^2}\right)^2 + \hat{z}^2 - w^2 &= 0 \\
  \left( r - \sqrt{\hat{x}^2 + \hat{y}^2}\right)^2 &= - \hat{z}^2 + w^2 \\
  r^2 - 2 r \sqrt{\hat{x}^2 + \hat{y}^2} + \hat{x}^2 + \hat{y}^2 &= - \hat{z}^2 + w^2 \\
  - 2 r \sqrt{\hat{x}^2 + \hat{y}^2}&= - \hat{x}^2 - \hat{y}^2 - \hat{z}^2 - r^2 + w^2 \\
  2 r \sqrt{\hat{x}^2 + \hat{y}^2}&=\hat{x}^2 + \hat{y}^2 + \hat{z}^2 + r^2 - w^2 \\
  4 r^2 \left(\hat{x}^2 + \hat{y}^2\right) &= \left(\hat{x}^2 + \hat{y}^2 + \hat{z}^2 + r^2 - w^2\right)^2 \\
  0 &= \left(\hat{x}^2 + \hat{y}^2 + \hat{z}^2 + r^2 - w^2\right)^2 - 4 r^2 \left(\hat{x}^2 + \hat{y}^2\right) \\
\end{align*}

Now we substitute $X = (\hat x,\hat y,\hat z)^T$ with a parametric ray $ray(t) = X_o + X_d t$, where $X_o = (a,b,c)^T, X_d = (x,y,z)^T$:

\[
  ((a + x t)^2 + (b + y t)^2 + (c + z t)^2 + R^2 - w^2)^2-4 r^2 ((a+x t)^2 + (b+y t)^2) 
\]

Expanding yields:\\\\
$ a^4+4 a^3 t x+2 a^2 b^2+4 a^2 b t y+2 a^2 c^2+4 a^2 c t z-2 a^2 r^2+6 a^2 t^2 x^2 $\\
$ +2 a^2 t^2 y^2+2 a^2 t^2 z^2-2 a^2 w^2+4 a b^2 t x+8 a b t^2 x y+4 a c^2 t x+8 a c t^2 x z $\\
$ -4 a r^2 t x+4 a t^3 x^3+4 a t^3 x y^2+4 a t^3 x z^2-4 a t w^2 x+b^4+4 b^3 t y $\\
$ +2 b^2 c^2+4 b^2 c t z-2 b^2 r^2+2 b^2 t^2 x^2+6 b^2 t^2 y^2+2 b^2 t^2 z^2-2 b^2 w^2 $\\
$ +4 b c^2 t y+8 b c t^2 y z-4 b r^2 t y+4 b t^3 x^2 y+4 b t^3 y^3+4 b t^3 y z^2 $\\
$ -4 b t w^2 y+c^4+4 c^3 t z+2 c^2 r^2+2 c^2 t^2 x^2+2 c^2 t^2 y^2+6 c^2 t^2 z^2 $\\
$ -2 c^2 w^2+4 c r^2 t z+4 c t^3 x^2 z+4 c t^3 y^2 z+4 c t^3 z^3-4 c t w^2 z+r^4 $\\
$ -2 r^2 t^2 x^2-2 r^2 t^2 y^2+2 r^2 t^2 z^2-2 r^2 w^2+t^4 x^4+2 t^4 x^2 y^2+2 t^4 x^2 z^2 $\\
$ +t^4 y^4+2 t^4 y^2 z^2+t^4 z^4-2 t^2 w^2 x^2-2 t^2 w^2 y^2-2 t^2 w^2 z^2+w^4 $\\

We collect the terms w.r.t to powers of $t$:
\begin{align*}
   t^0 \cdot &( a^4+2 a^2 b^2+b^4+2 a^2 c^2+2 b^2 c^2+c^4-2 a^2 r^2-2 b^2 r^2 \\
             &+ 2 c^2 r^2+r^4-2 a^2 w^2-2 b^2 w^2-2 c^2 w^2-2 r^2 w^2+w^4) \\
  +t^1 \cdot &(4 a^3 x+4 a b^2 x+4 a c^2 x-4 a r^2 x-4 a w^2 x+4 a^2 b y \\
             &+4 b^3 y+4 b c^2 y-4 b r^2 y-4 b w^2 y+4 a^2 c z+4 b^2 c z \\
             &+4 c^3 z+4 c r^2 z-4 c w^2 z) \\
  +t^2 \cdot &(6 a^2 x^2+2 b^2 x^2+2 c^2 x^2-2 r^2 x^2-2 w^2 x^2+8 a b x y \\
             &+2 a^2 y^2+6 b^2 y^2+2 c^2 y^2-2 r^2 y^2-2 w^2 y^2+8 a c x z \\
             &+8 b c y z+2 a^2 z^2+2 b^2 z^2+6 c^2 z^2+2 r^2 z^2-2 w^2 z^2) \\
  +t^3 \cdot &(4 a x^3+4 b x^2 y+4 a x y^2+4 b y^3+4 c x^2 z+4 c y^2 z \\
             &+4 a x z^2+4 b y z^2+4 c z^3) \\
  +t^4 \cdot &(x^4+2 x^2 y^2+y^4+2 x^2 z^2+2 y^2 z^2+z^4)
\end{align*}\\

This can be a little bit simplified:
\begin{align*}
   t^0 \cdot &( a^4+2 a^2 b^2+b^4+2 a^2 c^2+2 b^2 c^2+c^4-2 a^2 r^2-2 b^2 r^2 \\
             &+ 2 c^2 r^2+r^4-2 a^2 w^2-2 b^2 w^2-2 c^2 w^2-2 r^2 w^2+w^4) \\
  +t^1 \cdot &4((a^2+b^2+c^2-r^2-w^2) (a x+b y)+c (a^2+b^2+c^2+r^2-w^2) z) \\
  +t^2 \cdot &2((c^2-r^2-w^2) (x^2+y^2)+4 b c y z+(3 c^2+r^2-w^2) z^2 \\
             &+4 a x (b y+c z)+a^2 (3 x^2+y^2+z^2)+b^2 (x^2+3 y^2+z^2)) \\
  +t^3 \cdot &4(a x+b y+c z) (x^2+y^2+z^2) \\
  +t^4 \cdot &(x^2+y^2+z^2)^2
\end{align*}

And assuming that $X_d$ is normalized, $X_d \bot X_o$ and $r = 1$:
\begin{align*}
   t^0 \cdot &\left(a^4+2 a^2 \left(b^2+c^2-w^2-1\right)+b^4+2 b^2 \left(c^2-w^2-1\right)+\left(c^2-w^2+1\right)^2\right) \\
  +t^1 \cdot &8 c z \\
  +t^2 \cdot &2 \left(a^2+b^2+c^2-w^2+2 z^2-1\right)\\
  +t^4  &
\end{align*}

\newpage
Now if we solve for $t$ we get a pretty big formula, but a lot of the expressions are equal. So we substitute some of them for readability:

\[\alpha = a^2+b^2+c^2-w^2+2 z^2-1\]
\[\beta = a^4+2 b^2 a^2+2 c^2 a^2-2 w^2 a^2-2 a^2+b^4+c^4+w^4-2 b^2+2 b^2 c^2+2 c^2-2 b^2 w^2-2 c^2 w^2-2 w^2+1\]
\[\gamma = 16 \left(\alpha\right)^3-144 \left(\beta\right) \left(\alpha\right)+1728 c^2 z^2\]
\[\delta = 4 \left(\alpha\right)^2+12 \left(\beta\right)\]
\[\epsilon = \sqrt{\left(\gamma\right)^2-4 \left(\delta\right)^3} \]
\[\zeta = \sqrt[3]{\frac{\gamma+\epsilon}{2}} \]

The 4 solutions:\\

$
t\to \frac{1}{2} \sqrt{\frac{\zeta}{3}-\frac{4}{3} \left(\alpha\right)+\frac{1}{3\zeta}\left(\delta\right)}-\frac{1}{2} \sqrt{-\frac{\zeta}{3}-\frac{8}{3} \left(\alpha\right)-\frac{1}{3\zeta}\left(\delta\right)-\frac{16 c z}{\sqrt{\frac{\zeta}{3}-\frac{4}{3} \left(\alpha\right)+\frac{1}{3 \zeta}\left(\delta\right)}}}
$\\

$
t\to \frac{1}{2} \sqrt{\frac{\zeta}{3}-\frac{4}{3} \left(\alpha\right)+\frac{1}{3\zeta}\left(\delta\right)}+\frac{1}{2} \sqrt{-\frac{\zeta}{3}-\frac{8}{3} \left(\alpha\right)-\frac{1}{3\zeta}\left(\delta\right)-\frac{16 c z}{\sqrt{\frac{\zeta}{3}-\frac{4}{3} \left(\alpha\right)+\frac{1}{3 \zeta}\left(\delta\right)}}}
$\\

$
t\to -\frac{1}{2} \sqrt{\frac{\zeta}{3}-\frac{4}{3} \left(\alpha\right)+\frac{1}{3\zeta}\left(\delta\right)}-\frac{1}{2} \sqrt{-\frac{\zeta}{3}-\frac{8}{3} \left(\alpha\right)-\frac{1}{3\zeta}\left(\delta\right)+\frac{16 c z}{\sqrt{\frac{\zeta}{3}-\frac{4}{3} \left(\alpha\right)+\frac{1}{3 \zeta}\left(\delta\right)}}}
$\\

$
t\to -\frac{1}{2} \sqrt{\frac{\zeta}{3}-\frac{4}{3} \left(\alpha\right)+\frac{1}{3\zeta}\left(\delta\right)}+\frac{1}{2} \sqrt{-\frac{\zeta}{3}-\frac{8}{3} \left(\alpha\right)-\frac{1}{3\zeta}\left(\delta\right)+\frac{16 c z}{\sqrt{\frac{\zeta}{3}-\frac{4}{3} \left(\alpha\right)+\frac{1}{3 \zeta}\left(\delta\right)}}}
$\\

\end{document}
